------

# 通用数据采集器 (UniversalDataCollector) 操作说明书

## 1. 软件简介

本软件旨在为工业现场提供通用的数据采集与上传方案。支持实时监控本地 Excel (`.xlsx`, `.xls`) 或 CSV 文件，自动解析数据并将其上传至指定的 MES 接口。

**核心功能：**

- **多格式支持**：兼容 `.xlsx`, `.xls` (二进制 Excel) 及 `.csv` (文本)。
- **灵活监控**：支持“单文件追加模式”和“文件夹批量模式”。
- **数据过滤**：可设置跳过前 N 行（如表头、无关描述）。
- **自定义映射**：可视化的 MES 字段与 Excel 列索引映射配置。
- **断点续传**：自动记录采集进度，软件重启后不丢失数据，不重复上传。
- **本地备份**：上传成功的数据会自动备份为标准 CSV 格式，防止数据丢失。

------

## 2. 运行环境

- **操作系统**：Windows 7 SP1 / Windows 10 / Windows 11
- **依赖框架**：.NET Framework 4.5.1 或更高版本
- **Office环境**：无需安装 Office Excel（内置独立解析引擎）

------

## 3. 快速上手

### 3.1 启动软件

双击运行 `UniversalDataCollector.exe`。

- **主界面**：显示当前的上传日志、上传状态以及最新采集的数据列表。
- **首次运行**：建议先进行 [4. MES 接口配置] 和 [5. 监控路径配置]。

------

## 4. MES 接口配置 (MesSetting)

点击主界面菜单或按钮进入 **“MES接口配置”** 窗口。

### 4.1 设置 API 地址

在顶部的输入框中填写 MES 系统的接收接口地址。

> **示例**：`http://192.168.1.100:8080/api/upload`

### 4.2 配置字段映射

这是将 Excel 里的列对应到 MES 系统字段的关键步骤。

1. **添加字段**：点击右下角的 **“➕ 新增字段”** 按钮。
2. **编辑映射**：
   - **MES字段名**：填写 MES 接口要求的 JSON 字段名（如 `machine_id`, `temperature`）。
   - **Excel列索引**：填写该数据在 Excel 文件中是第几列（**注意：从 0 开始计数**）。
     - *第 1 列填 0，第 2 列填 1，以此类推。*
   - **数据类型**：下拉选择数据类型（`String`, `Int`, `Double`, `DateTime`）。
3. **删除字段**：选中不需要的行，点击 **“➖ 删除选中”** 按钮。
4. **保存**：点击 **“💾 保存配置”**，系统提示保存成功即生效。

------

## 5. 监控路径配置 (MonitorSetting)

点击主界面菜单或按钮进入 **“监控路径配置”** 窗口。

### 5.1 选择工作模式

- **单文件监控 (追加模式)**：
  - 适用于：设备一直往同一个 Excel 文件里写入新数据。
  - 逻辑：软件会记住上次读到了第几行，下次只读新增加的行。
- **文件夹监控 (批量模式)**：
  - 适用于：设备每次测试生成一个新的文件（如 `Test_01.xlsx`, `Test_02.xlsx`）。
  - 逻辑：软件会监控文件夹，一旦出现新文件，自动读取并上传，处理完后标记为“已处理”。

### 5.2 路径与过滤设置

- **单文件模式**：点击 **“浏览...”** 选择目标 Excel 文件。
- **文件夹模式**：点击 **“选择目录”** 选择监控文件夹。
  - **文件过滤**：填写文件名规则，如 `*.xlsx`（只读新版Excel）或 `*.*`（读取所有）。

### 5.3 数据采集规则 (**重要**)

针对工业现场 Excel 文件通常包含表头或设备信息的情况，必须设置此项。

- **起始有效行**：
  - 填写 **1**：代表从第 1 行开始读取（无表头）。
  - 填写 **6**：代表 **跳过前 5 行**，从第 6 行开始采集数据。
  - *请根据实际 Excel 文件内容设置，避免将表头文字当做数据上传导致报错。*

### 5.4 扫描频率

拖动滑块设置扫描间隔（建议 **3-5秒**）。设置太短可能导致文件被占用，设置太长实时性较差。

------

## 6. 主界面监控与日志

配置完成后，主界面会自动开始工作：

1. **状态栏**：
   - 显示“等待新文件...”：表示文件夹模式下暂无新文件。
   - 显示“监控单文件.../上传中...”：表示正在处理数据。
2. **数据列表**：
   - 成功上传的数据会实时显示在下方的表格中。
3. **日志窗口**：
   - 显示操作记录，如 `[10:25:30] 上传成功: {"temp": 25.5}`。
   - **异常排查**：如果出现红色报错信息，请检查网络或配置。

------

## 7. 常见问题排查 (Q&A)

### Q1: 软件读取不到 Excel 数据，日志也没反应？

- **检查1**：确认 **“起始有效行”** 设置是否正确。如果文件只有 5 行，而你设置从第 6 行开始读，自然读不到数据。
- **检查2**：确认 **“文件过滤”** 后缀是否匹配。如果文件是 `.xls`，但你设置了只看 `*.xlsx`，会导致漏读。
- **检查3**：如果是文件夹模式，确认文件是否是 **新生成** 的。历史文件（软件运行前已存在的文件）默认可能已被标记为处理过（需清理 `FolderMode_History.db` 文件重置）。

### Q2: 上传失败，日志显示 "400 Bad Request" 或 "500 Error"？

- 这是 MES 服务器返回的错误。
- 请检查 **MES接口配置** 中的 **“数据类型”** 是否正确。例如 MES 要求数字类型，但 Excel 里该列包含了文字或空值。
- 请检查 **列索引** 是否填错（记得是从 0 开始数）。

### Q3: Excel 文件总是提示“被占用”？

- 虽然软件使用了共享读写模式，但如果 Excel 正在被人工打开编辑，可能会导致冲突。建议在采集期间尽量不要手动打开正在写入的文件。

### Q4: 如何重置软件的所有记忆？

- 关闭软件，进入软件根目录。
- 删除以下文件：
  - `SingleMode_Row.cache` (重置单文件读取进度)
  - `FolderMode_History.db` (重置文件夹处理记录)
- 重启软件，它将从头开始扫描。

------

## 8. 数据备份说明

所有成功上传的数据，会自动备份在软件目录下的 **ExportData** 文件夹中。备份文件为标准 CSV 格式（UTF-8 编码），可用 Excel 直接查看，确保数据万无一失。