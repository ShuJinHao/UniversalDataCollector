------

# 通用数据采集器 (UniversalDataCollector) 操作说明书

## 1. 软件简介

本软件旨在为工业现场提供通用的数据采集与上传方案。支持实时监控本地 Excel (`.xlsx`, `.xls`) 或 CSV 文件，自动解析数据并将其上传至指定的 MES 接口。

**核心功能：**

- **多格式支持**：兼容 `.xlsx`, `.xls` (二进制 Excel) 及 `.csv` (文本)。
- **多源数据融合 (New)**：支持读取 CSV/Excel 中的模板文件名，自动挂载并解析外部 `.tpld` 参数文件，将规格参数与测试数据合并上传。
- **灵活监控**：支持“单文件追加模式”和“文件夹批量模式”。
- **数据过滤**：可设置跳过前 N 行（如表头、无关描述）。
- **自定义映射**：可视化的 MES 字段与 Excel 列索引映射配置。
- **断点续传**：自动记录采集进度，软件重启后不丢失数据，不重复上传。
- **本地备份**：上传成功的数据会自动备份为标准 CSV 格式，防止数据丢失。

------

## 2. 运行环境

- **操作系统**：Windows 7 SP1 / Windows 10 / Windows 11
- **依赖框架**：.NET Framework 4.5.1 或更高版本
- **Office环境**：无需安装 Office Excel（内置独立解析引擎）

------

## 3. 快速上手

### 3.1 启动软件

双击运行 `UniversalDataCollector.exe`。

- **主界面**：显示当前的上传日志、上传状态以及最新采集的数据列表。
- **首次运行**：建议按顺序进行 [4. MES 接口配置]、[5. 模板增强配置] 和 [6. 监控路径配置]。

------

## 4. MES 接口配置 (MesSetting)

点击主界面菜单或按钮进入 **“MES接口配置”** 窗口。

### 4.1 设置 API 地址

在顶部的输入框中填写 MES 系统的接收接口地址。

> **示例**：`http://192.168.1.100:8080/api/upload`

### 4.2 配置字段映射

这是将 Excel/CSV 里的列对应到 MES 系统字段的关键步骤。

1. **添加字段**：点击右下角的 **“➕ 新增字段”** 按钮。
2. **编辑映射**：
   - **MES字段名**：填写 MES 接口要求的 JSON 字段名（如 `Barcode`, `V1`）。
   - **Excel列索引**：填写该数据在 Excel 文件中是第几列（**注意：从 0 开始计数**）。
   - **数据类型**：下拉选择数据类型。
     - **String** / **Int** / **Double**：基础类型。
     - **DoubleArray**：自动将空格分隔的字符串解析为数组（如 `3.4 3.5` -> `[3.4, 3.5]`）。
     - **TemplateFile (关键)**：**选中此类型，代表该列的内容是“模板文件名”**（如 `H-2p6s-61.tpld`）。系统将自动根据此文件名去查找并解析外部参数文件。
3. **保存**：点击 **“💾 保存配置”**，系统提示保存成功即生效。

------

## 5. 模板增强功能配置 (TemplateConfig)

当你在第 4 步中将某一列配置为 `TemplateFile` 后，需要配置软件如何解析这些模板文件。

请在软件根目录下找到或创建 **TemplateConfig.json** 文件，并按以下规则配置：

### 5.1 配置文件说明

该文件定义了模板文件的存储路径以及如何从文本中提取参数（如电压上下限）。

**配置示例：**

JSON



```
{
  "EnableTemplateEnricher": true,          // 功能总开关
  "TemplateFolderPath": "D:\\Data\\Templates", // .tpld 文件的存放目录
  "ExtractionRules": [                     // 提取规则列表
    {
      "TargetKey": "Limit.PackV.Min",      // MES 接收的字段名 (支持 . 分层)
      "MatchPattern": "^v_min=(.*)",       // 正则表达式：提取 v_min= 后面的值
      "DataType": "Double"                 // 数据类型
    },
    {
      "TargetKey": "Limit.PackV.Max",
      "MatchPattern": "^v_max=(.*)",
      "DataType": "Double"
    }
  ]
}
```

### 5.2 常用配置项解释

- **TemplateFolderPath**：必须修改为您现场实际存放 `.tpld` 文件的文件夹路径。
- **MatchPattern**：用于从 `.tpld` 文件中抓取数据的正则表达式。
  - 抓取 `v_min=33.6`：使用 `^v_min=(.*)`
  - 抓取 `hi_protect=120`：使用 `^hi_protect=(.*)`
- **TargetKey**：提取出的数据在上传给 MES 时叫什么名字。支持多级结构，例如写成 `Limit.PackV.Min`，MES 收到的 JSON 就会自动变成嵌套结构。

------

## 6. 监控路径配置 (MonitorSetting)

点击主界面菜单或按钮进入 **“监控路径配置”** 窗口。

### 6.1 选择工作模式

- **单文件监控 (追加模式)**：
  - 适用于：设备一直往同一个 Excel 文件里写入新数据。
  - 逻辑：软件会记住上次读到了第几行，下次只读新增加的行。
- **文件夹监控 (批量模式)**：
  - 适用于：设备每次测试生成一个新的文件（如 `Test_01.csv`, `Test_02.csv`）。
  - 逻辑：软件会监控文件夹，一旦出现新文件，自动读取并上传，处理完后标记为“已处理”。

### 6.2 路径与过滤设置

- **单文件模式**：点击 **“浏览...”** 选择目标数据文件。
- **文件夹模式**：点击 **“选择目录”** 选择监控文件夹。
- **起始有效行**：**非常重要**。如果文件第一行是表头（Barcode, V1...），请填写 **1**（代表跳过第 0 行，从第 1 行读数据）。如果前 13 行都是无用信息，请填写 **13**。

### 6.3 扫描频率

拖动滑块设置扫描间隔（建议 **3-5秒**）。

------

## 7. 主界面监控与日志

配置完成后，主界面会自动开始工作：

1. **状态栏**：
   - 显示“监控中... / 正在上传...”：表示系统运行正常。
2. **数据列表**：
   - 表格会自动显示解析后的数据。
   - 如果配置了模板增强，表格中会自动增加从模板解析出来的列（如 `Limit.PackV.Max`）。
3. **日志窗口**：
   - 显示操作记录，如 `[10:25:30] 发现新文件: Data.csv`。
   - `[10:25:31] 锁定模板: H-2p6s-61.tpld`：表示成功找到了对应的模板文件。

------

## 8. 常见问题排查 (Q&A)

### Q1: 上传的数据里没有模板参数（Limit信息）？

- **检查1**：确认 **MES接口配置** 中，是否有一列的数据类型被选为了 `TemplateFile`。
- **检查2**：确认 Excel/CSV 该列的内容（如 `A.tpld`）在 **TemplateFolderPath** 指定的文件夹里是否真的存在该文件。
- **检查3**：检查 `TemplateConfig.json` 里的正则表达式是否匹配 `.tpld` 文件的实际内容格式。

### Q2: 软件读取不到 Excel 数据？

- **检查**：确认 **“起始有效行”** 设置是否正确。如果文件只有 5 行，而你设置从第 6 行开始读，自然读不到数据。

### Q3: 修改了 `.tpld` 文件，需要重启软件吗？

- **不需要**。软件内置了热更新监控，一旦修改并保存了 `.tpld` 文件，软件会自动更新缓存，下一条上传的数据就会使用最新的参数。

### Q4: 如何重置软件的所有记忆？

- 关闭软件，进入软件根目录。
- 删除 `SingleMode_Row.cache` (单文件进度) 和 `FolderMode_History.db` (文件夹记录)。
- 重启软件。

------

## 9. 数据备份说明

所有成功上传的数据，会自动备份在软件目录下的 **ExportData** 文件夹中。备份文件为标准 CSV 格式（UTF-8 编码），包含所有 CSV 原始数据以及 **融合后的模板参数**，可直接用于追溯验证。