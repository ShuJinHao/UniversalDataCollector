------

# 🛠️ 通用数据采集器 (UniversalDataCollector) 操作说明书

本工具是一款基于 **WPF (MVVM)** 架构的轻量级桌面程序，专门用于监控本地 CSV 数据并实时同步至 MES 系统。它支持 **Win7 兼容**、**断点续传**、以及**动态字段映射**。

------

## 1. 核心功能概览

- **双模式监控**：支持“死磕单个文件”或“监控整个文件夹（自动找最新）”。
- **动态映射**：无需改代码，直接在界面配置 CSV 第 X 列对应 MES 的哪个字段。
- **智能上传**：自动处理科学计数法，支持 TLS 1.2 安全协议。
- **防呆重启**：支持全局单实例运行，重启时自动恢复监控状态。

------

## 2. 动态配置指南 (核心)

本程序最强大的地方在于 **“动态映射”**。你可以在不重启软件（或仅通过重启生效）的情况下，通过界面调整数据逻辑。

### 2.1 MES 字段映射配置

1. 点击主界面的 **“MES配置”** 按钮。
2. **API 地址**：填入 MES 的接收接口（例如 `http://api.mes.com/upload`）。
3. **添加映射**：
   - 点击 **“添加字段映射”**。
   - **MES 字段名**：MES 接口要求的 JSON 键名（如 `temperature`）。
   - **CSV 列索引**：该数据在 CSV 文件中的位置。**注意：从 0 开始计数**（第 1 列填 0，第 2 列填 1）。
   - **数据类型**：
     - `String`: 文本。
     - `Int`: 整数（会自动把 `1.0` 这种格式转为 `1`）。
     - `Double`: 浮点数（**自动去除科学计数法**，1E+07 会转为 10000000）。
     - `DateTime`: 时间（若 CSV 时间格式异常，自动补偿为当前系统时间）。
4. **保存**：点击保存后，配置将写入 `AppConfig.json`。

### 2.2 监控路径配置

1. 点击主界面的 **“路径配置”** 按钮。
2. **模式切换**：选择“单文件”或“文件夹”。
3. **浏览/选择**：点击按钮选择你要监控的目标。
4. **保存并重启**：系统会提示重启，重启后程序将**自动开始**监控。

------

## 3. 通用错误处理机制

为了保证工业现场 24 小时运行不掉链子，程序内置了以下“保命”逻辑：

### 3.1 采集端逻辑 (Monitor Error Handling)

- **文件占用**：如果 CSV 正在被 PLC 或 Excel 打开，程序会使用 `FileShare.ReadWrite` 模式强行读取，不会报错崩溃。
- **断点续传**：程序会自动记录最后读取的行号并存入 `RowIndex.cache`。**意外断电或重启后，会自动从该行继续，绝不重复上传。**
- **文件切换**：在文件夹模式下，若检测到产生了新的 CSV 文件，程序会记录旧文件进度并自动重置行号读取新文件。

### 3.2 上传端逻辑 (MES Error Handling)

- **科学计数法拦截**：所有 Double 类型在上传前都会经过强制格式化，规避 MES 系统无法识别 `1.23E+05` 的问题。
- **上传重试**：若 MES 接口返回失败（如网络抖动），程序会**立即停止当前扫描循环**，保留当前行号，并在下一个周期（默认 3 秒后）重新尝试上传该行。**“死磕”到底，确保每一行都不丢。**

### 3.3 系统级防护 (System Logic)

- **禁止多开**：程序启动时会检测全局互斥锁（Mutex）。若已有一个程序在运行，新程序将无法启动并弹出提示。
- **按天分档日志**：日志存放在 `Logs` 文件夹下，文件名格式为 `yyyy-MM-dd.txt`。程序启动时会自动清理 30 天前的旧日志，防止撑爆硬盘。

------

## 4. 常见问题 (FAQ)

**Q: 为什么我修改了 CSV，程序却没有上传？**

> **A:** 请检查主界面右下角的运行状态是否为“运行中”。如果是“已停止”，请检查路径配置是否正确，并点击“开始监控”。

**Q: 上传的数据乱码怎么办？**

> **A:** 本程序默认使用 `Encoding.Default` (GB2312) 读取。如果你的 CSV 是 UTF-8 编码，请联系开发人员微调 `MonitorService.cs` 中的编码设置。

**Q: 如何清空进度重新采集？**

> **A:** 关闭程序，手动删除根目录下的 `RowIndex.cache` 文件，重新启动即可从头开始采集。

------

> **温馨提示**：配置完成后，建议手动触发一次“保存并重启”，观察主界面日志是否出现 `▶ 监控已启动` 字样。

------

