<Window
    x:Class="UniversalDataCollector.Views.MesSettingWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:vm="clr-namespace:UniversalDataCollector.ViewModels"
    Title="MES 上传映射配置"
    Width="750"
    Height="500"
    Background="#F5F5F5"
    WindowStartupLocation="CenterScreen">

    <Window.DataContext>
        <vm:MesSettingViewModel />
    </Window.DataContext>

    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <GroupBox
            Grid.Row="0"
            Margin="0,0,0,15"
            Padding="10"
            Header="接口配置">
            <StackPanel>
                <TextBlock
                    Margin="0,0,0,5"
                    Foreground="#333"
                    Text="MES 接口 API 地址:" />
                <TextBox
                    Height="28"
                    VerticalContentAlignment="Center"
                    Text="{Binding Config.MesApiUrl, UpdateSourceTrigger=PropertyChanged}" />
            </StackPanel>
        </GroupBox>

        <StackPanel
            Grid.Row="1"
            Margin="0,0,0,10"
            Orientation="Horizontal">
            <Button
                Width="120"
                Height="30"
                Background="#007ACC"
                BorderThickness="0"
                Command="{Binding AddMappingCommand}"
                Foreground="White">
                <StackPanel Orientation="Horizontal">
                    <TextBlock Margin="0,0,5,0" Text="➕" />
                    <TextBlock Text="添加字段映射" />
                </StackPanel>
            </Button>
            <TextBlock
                Margin="15,0,0,0"
                VerticalAlignment="Center"
                FontStyle="Italic"
                Foreground="#666"
                Text="* 提示：CSV列索引从0开始（0=第1列）" />
        </StackPanel>

        <DataGrid
            Grid.Row="2"
            AutoGenerateColumns="False"
            Background="White"
            BorderBrush="#DDD"
            CanUserAddRows="False"
            HorizontalGridLinesBrush="#EEE"
            ItemsSource="{Binding Config.Mappings}"
            RowHeight="32"
            VerticalGridLinesBrush="#EEE">
            <DataGrid.Columns>
                <DataGridTextColumn
                    Width="*"
                    Binding="{Binding MesFieldName, UpdateSourceTrigger=PropertyChanged}"
                    Header="MES 字段名" />

                <DataGridTextColumn
                    Width="100"
                    Binding="{Binding ColumnIndex, UpdateSourceTrigger=PropertyChanged}"
                    Header="CSV 列索引" />

                <DataGridTemplateColumn Width="120" Header="数据类型">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <ComboBox
                                BorderThickness="0"
                                SelectedValue="{Binding DataType, UpdateSourceTrigger=PropertyChanged}"
                                SelectedValuePath="Content">
                                <ComboBoxItem Content="String" />
                                <ComboBoxItem Content="Int" />
                                <ComboBoxItem Content="Double" />
                                <ComboBoxItem Content="DateTime" />
                            </ComboBox>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>

                <DataGridTextColumn
                    Width="100"
                    Binding="{Binding DefaultValue, UpdateSourceTrigger=PropertyChanged}"
                    Header="默认值" />

                <DataGridTemplateColumn Width="60" Header="操作">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <Button
                                Background="Transparent"
                                BorderThickness="0"
                                Command="{Binding DataContext.DeleteMappingCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                CommandParameter="{Binding}"
                                Content="删除"
                                Cursor="Hand"
                                Foreground="Red" />
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>
            </DataGrid.Columns>
        </DataGrid>

        <StackPanel
            Grid.Row="3"
            Margin="0,20,0,0"
            HorizontalAlignment="Right"
            Orientation="Horizontal">
            <Button
                Width="100"
                Height="32"
                Margin="0,0,10,0"
                Background="#4CAF50"
                BorderThickness="0"
                Command="{Binding SaveCommand}"
                Content="保存配置"
                Foreground="White" />

            <Button
                Width="80"
                Height="32"
                Background="#DDD"
                BorderThickness="0"
                Click="Close_Click"
                Content="关闭" />
        </StackPanel>
    </Grid>
</Window>